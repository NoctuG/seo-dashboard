# 自托管 SEO Dashboard — 缺失功能分析

> 基于对现有代码库的全面审查，以下按优先级列出作为轻量级自托管项目仍需补齐的功能。

---

## 一、关键缺失（P0 — 自托管必备）

### 1. 健康检查端点

**现状**：仅有 `GET /` 返回静态 JSON，无标准化健康检查。

**需要**：
- `GET /api/v1/health` — 返回应用状态、数据库连接状态、调度器状态
- `GET /api/v1/health/ready` — 就绪探针（readiness probe）
- Docker Compose 中添加 `healthcheck` 指令

**原因**：Docker / Kubernetes 编排、负载均衡器、运维监控均依赖健康检查。

---

### 2. 用户管理 API 与界面

**现状**：
- 只有 `bootstrap-admin` 创建首个管理员
- 无用户增删改查（CRUD）API
- 无前端用户管理页面
- 无邀请用户 / 注册流程

**需要**：
- `POST /api/v1/users` — 管理员创建用户
- `GET /api/v1/users` — 用户列表
- `PATCH /api/v1/users/{id}` — 编辑用户（角色、状态）
- `DELETE /api/v1/users/{id}` — 停用/删除用户
- 前端用户管理页面（仅 superuser 可见）
- 用户邀请流程（可选：邮件邀请链接）

**原因**：多人协作是自托管场景的基本需求，当前没有任何途径添加第二个用户。

---

### 3. 密码修改与重置

**现状**：无密码修改、无密码重置端点。

**需要**：
- `POST /api/v1/auth/change-password` — 已登录用户改密
- `POST /api/v1/auth/forgot-password` + `POST /api/v1/auth/reset-password` — 密码重置流程（依赖邮件发送）
- 前端对应表单

**原因**：安全基线要求。用户遗忘密码后当前只能手动操作数据库。

---

### 4. HTTPS / TLS 支持

**现状**：Nginx 仅监听 HTTP 80 端口，无 TLS 配置。

**需要**：
- Nginx 配置支持 HTTPS（443），自动 HTTP→HTTPS 跳转
- 支持挂载自签证书或 Let's Encrypt 证书
- docker-compose 中暴露 443 端口、映射证书目录
- 或提供与反向代理（Caddy / Traefik）配合的文档说明

**原因**：自托管部署在公网或内网均需加密传输，JWT token 在 HTTP 下极易被截获。

---

### 5. CORS 安全收紧

**现状**：`allow_origins=["*"]`，允许任意来源访问 API。

**需要**：
- 通过环境变量 `ALLOWED_ORIGINS` 配置可信来源列表
- 默认值为 `["http://localhost:80", "http://localhost:3000"]`
- 生产环境必须配置为实际域名

**原因**：当前配置存在 CSRF / 跨站请求伪造风险。

---

### 6. 数据备份与恢复

**现状**：SQLite 数据存储在 Docker volume 中，无内置备份机制。

**需要**：
- `POST /api/v1/admin/backup` — 导出数据库快照（SQLite 文件 `.backup` 或 SQL dump）
- `POST /api/v1/admin/restore` — 从备份恢复
- 可选：定时自动备份（cron job）
- docker-compose 中添加备份卷映射说明
- 至少在文档中提供手动备份命令

**原因**：数据丢失对自托管用户是灾难性的。SQLite 单文件特性使备份实现成本很低。

---

## 二、重要缺失（P1 — 显著影响使用体验）

### 7. 邮件发送服务（SMTP）

**现状**：
- 报表调度功能有 `recipient_email` 字段
- `ReportDeliveryLog` 记录投递状态
- 但 **没有任何 SMTP / 邮件发送代码**

**需要**：
- 集成 SMTP 发送（`smtplib` 或 `aiosmtplib`）
- 环境变量：`SMTP_HOST`, `SMTP_PORT`, `SMTP_USER`, `SMTP_PASSWORD`, `SMTP_FROM`
- 报表调度真正发送邮件
- 密码重置邮件依赖此功能

**原因**：报表定时投递和密码重置都是空壳，无法实际执行。

---

### 8. API 速率限制

**现状**：无任何速率限制。

**需要**：
- 全局速率限制（如 `slowapi` 集成）
- 登录端点单独限制（防暴力破解，如 5 次/分钟）
- 爬虫启动端点限制（防资源滥用）
- 返回标准 `429 Too Many Requests` 及 `Retry-After` 头

**原因**：自托管暴露在网络中时，无速率限制的登录端点是严重安全隐患。

---

### 9. JWT Token 刷新机制

**现状**：JWT 令牌 24 小时过期后需重新登录，无刷新机制。

**需要**：
- `POST /api/v1/auth/refresh` — 使用有效 token 换取新 token
- 前端 Axios 拦截器自动刷新
- 可选：Refresh Token + Access Token 双 token 机制

**原因**：用户长时间使用时频繁被迫重新登录，体验差。

---

### 10. 爬虫进度实时反馈

**现状**：爬虫通过 BackgroundTask 异步执行，前端只能轮询 `crawl.status`。

**需要**：
- WebSocket 或 SSE（Server-Sent Events）推送爬取进度
- 实时显示：已爬取页数、当前 URL、发现的问题数
- 爬虫完成后推送通知

**原因**：当前用户启动爬虫后只能盲等刷新，无法了解进度。

---

### 11. 前端错误边界（Error Boundary）

**现状**：无全局错误捕获，组件异常时白屏。

**需要**：
- React Error Boundary 组件包裹路由
- 友好的错误回退 UI（而非白屏）
- 错误信息上报（可选）

**原因**：生产环境中任何未捕获异常都会导致整个页面崩溃。

---

### 12. 系统设置界面

**现状**：所有配置只能通过 `.env` 文件修改，需重启容器。

**需要**：
- 管理员设置页面，可在线修改部分配置：
  - SMTP 设置
  - 分析服务提供商切换
  - AI 服务配置
  - 爬虫默认参数（页面上限、并发数）
- 配置持久化到数据库
- 敏感配置（API Key）脱敏显示

**原因**：非技术用户不应为了改一个配置去编辑环境变量并重启容器。

---

### 13. Webhook / 通知集成

**现状**：无任何外部通知渠道。

**需要**：
- 项目级 Webhook 配置（URL + Secret）
- 触发事件：爬虫完成、发现严重问题、排名大幅变动、报表生成
- 常见渠道适配：Slack / Discord / 企业微信 / 钉钉
- 通知模板自定义

**原因**：自托管用户希望在异常发生时主动收到通知，而非手动登录查看。

---

### 14. 结构化日志与日志管理

**现状**：使用 Python 标准 `logging`，输出到 stdout，无结构化格式。

**需要**：
- JSON 格式结构化日志（方便 ELK / Loki 等日志系统采集）
- 请求级别 trace ID
- 日志级别通过环境变量控制
- Docker 日志驱动配置说明

**原因**：排查生产问题时，非结构化日志难以检索和分析。

---

### 15. 环境变量启动校验

**现状**：缺少必要配置时在运行时才会报错。

**需要**：
- 启动时校验必要环境变量（`JWT_SECRET_KEY` 不能为默认值、数据库可达等）
- 关键配置缺失时应 fast-fail 并给出明确提示
- 生产模式下 `JWT_SECRET_KEY=change-me` 应拒绝启动

**原因**：避免使用默认不安全配置上线导致安全事故。

---

## 三、体验增强（P2 — 提升完整度）

### 16. 深色模式

**现状**：无主题切换，仅浅色模式。

**需要**：
- Tailwind CSS `dark:` 变体支持
- 主题切换按钮（亮 / 暗 / 跟随系统）
- `localStorage` 持久化偏好

---

### 17. API 分页标准化

**现状**：部分列表接口缺少分页参数或分页实现不一致。

**需要**：
- 统一分页参数：`page`, `page_size`
- 响应包含 `total`, `page`, `page_size`
- 前端表格组件支持分页控件

---

### 18. 双因素认证（2FA / TOTP）

**需要**：
- TOTP 实现（`pyotp` 库）
- 二维码绑定流程
- 登录时验证 TOTP 码
- 恢复码机制

**原因**：自托管暴露在公网时，仅密码认证不够安全。

---

### 19. API Key 认证

**需要**：
- 支持 API Key 方式调用 API（用于 CI/CD、脚本自动化）
- Key 管理界面（生成、吊销、权限范围）
- `X-API-Key` 或 `Authorization: Bearer <api-key>` 两种方式

---

### 20. Prometheus 监控指标

**需要**：
- `GET /metrics` — Prometheus 格式指标端点
- 指标包括：请求数、响应时间、爬虫任务数、数据库连接池、活跃用户数
- Grafana 仪表盘模板

---

### 21. 版本显示与更新提示

**需要**：
- 前端页脚 / 设置页显示当前版本号
- 可选：检查 GitHub Release 是否有新版本
- 更新日志（CHANGELOG）

---

### 22. 国际化完整性

**现状**：已集成 `i18next`，但翻译覆盖率未知。

**需要**：
- 检查并补全所有 UI 文本的中英文翻译
- 后端错误消息国际化
- 日期 / 数字格式本地化

---

## 四、汇总优先级矩阵

| 优先级 | 功能 | 类型 | 实现难度 |
|--------|------|------|----------|
| P0 | 健康检查端点 | 运维 | 低 |
| P0 | 用户管理 CRUD | 功能 | 中 |
| P0 | 密码修改/重置 | 安全 | 中 |
| P0 | HTTPS/TLS 支持 | 安全 | 低 |
| P0 | CORS 收紧 | 安全 | 低 |
| P0 | 数据备份与恢复 | 运维 | 低 |
| P1 | 邮件发送服务 | 功能 | 中 |
| P1 | API 速率限制 | 安全 | 低 |
| P1 | JWT Token 刷新 | 功能 | 低 |
| P1 | 爬虫进度实时反馈 | 体验 | 中 |
| P1 | 前端错误边界 | 稳定性 | 低 |
| P1 | 系统设置界面 | 体验 | 高 |
| P1 | Webhook 通知 | 功能 | 中 |
| P1 | 结构化日志 | 运维 | 低 |
| P1 | 启动配置校验 | 安全 | 低 |
| P2 | 深色模式 | 体验 | 中 |
| P2 | 分页标准化 | 功能 | 低 |
| P2 | 双因素认证 | 安全 | 中 |
| P2 | API Key 认证 | 功能 | 中 |
| P2 | Prometheus 指标 | 运维 | 中 |
| P2 | 版本显示 | 体验 | 低 |
| P2 | 国际化补全 | 体验 | 中 |

---

## 五、建议实施路径

**第一阶段（安全加固）**：CORS 收紧 → 启动配置校验 → HTTPS → 密码修改 → 速率限制

**第二阶段（核心功能补齐）**：用户管理 → 健康检查 → 数据备份 → JWT 刷新 → 错误边界

**第三阶段（通知与运维）**：SMTP 邮件 → Webhook 通知 → 结构化日志 → 爬虫实时进度

**第四阶段（体验优化）**：系统设置界面 → 深色模式 → 分页标准化 → 国际化补全

**第五阶段（高级安全）**：2FA → API Key → Prometheus 指标 → 版本管理
